<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compteur de FlÃ©chettes</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark base for gradient */
            background-image: radial-gradient(at 50% 0%, #2d3748, #1a202c 70%); /* Subtle radial gradient from top */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #333;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Enhanced button styles with more pronounced effects */
        .btn-gradient {
            background-size: 200% auto;
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease-in-out;
            border: none;
            cursor: pointer;
        }
        .btn-gradient:hover {
            background-position: right center; /* Change the gradient position */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            transform: translateY(-3px);
        }
        .btn-gradient:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary { background-image: linear-gradient(to right, #6366f1 0%, #8b5cf6 50%, #6366f1 100%); }
        .btn-success { background-image: linear-gradient(to right, #10b981 0%, #34d399 50%, #10b981 100%); }
        .btn-danger { background-image: linear-gradient(to right, #ef4444 0%, #f87171 50%, #ef4444 100%); }
        .btn-info { background-image: linear-gradient(to right, #0ea5e9 0%, #38bdf8 50%, #0ea5e9 100%); }
        .btn-dark-gradient { background-image: linear-gradient(to right, #4b5563 0%, #6b7280 50%, #4b5563 100%); }

        /* Specific styles for selected multiplier button */
        .btn-multiplier-selected {
            border: 3px solid #facc15; /* Yellow 400 */
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.8), inset 0 0 10px rgba(250, 204, 21, 0.5);
            transform: scale(1.05);
        }

        /* Player card active state */
        .player-card-active {
            border: 3px solid #3b82f6; /* Blue 500 */
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.8), inset 0 0 15px rgba(59, 130, 246, 0.5);
            transform: scale(1.03);
        }

        /* Main container shadow */
        .main-container {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7), 0 0 0 5px rgba(255, 255, 255, 0.05) inset;
            border-radius: 1rem;
            background-color: #2d3748; /* Darker background for content */
        }

        /* Input field focus glow */
        input:focus, select:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* Blue 500 with transparency */
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 text-white p-4 sm:p-8 flex flex-col items-center justify-center">

    <div class="main-container p-6 sm:p-8 w-full max-w-4xl border border-gray-700">
        <h1 class="text-5xl font-extrabold text-center mb-8 text-yellow-400 drop-shadow-lg tracking-wide">
            ðŸŽ¯ Compteur de FlÃ©chettes ðŸŽ¯
        </h1>

        <!-- Section de configuration du jeu -->
        <div id="config-section" class="mb-8 p-4 bg-gray-700 rounded-lg shadow-inner border border-gray-600">
            <h2 class="text-2xl font-bold mb-4 text-center text-blue-300">Configuration du Jeu</h2>

            <!-- Ajouter des joueurs -->
            <div class="mb-4">
                <label for="newPlayer" class="block text-lg font-medium mb-2 text-gray-200">
                    Ajouter un joueur:
                </label>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input
                        type="text"
                        id="newPlayer"
                        class="flex-grow p-3 rounded-md bg-gray-900 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Nom du joueur"
                    />
                    <button
                        id="addPlayerBtn"
                        class="btn-gradient btn-primary text-white font-bold py-3 px-6 rounded-md"
                    >
                        Ajouter
                    </button>
                </div>
            </div>

            <!-- Liste des joueurs -->
            <div id="players-list-container" class="mb-4 hidden">
                <h3 class="text-xl font-semibold mb-2 text-purple-300">Joueurs:</h3>
                <ul id="players-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <!-- Les joueurs seront ajoutÃ©s ici par JS -->
                </ul>
            </div>

            <!-- Choix du mode de jeu -->
            <div class="mb-6">
                <label for="gameMode" class="block text-lg font-medium mb-2 text-gray-200">
                    Mode de jeu:
                </label>
                <select
                    id="gameMode"
                    class="w-full p-3 rounded-md bg-gray-900 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    <option value="301">301</option>
                    <option value="501">501</option>
                </select>
            </div>

            <!-- Options de rÃ¨gles -->
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-2 text-green-300">Options de RÃ¨gles:</h3>
                <div class="flex items-center mb-2">
                    <input
                        type="checkbox"
                        id="doubleIn"
                        class="form-checkbox h-5 w-5 text-blue-600 rounded"
                    />
                    <label for="doubleIn" class="ml-2 text-lg text-gray-200">Double In</label>
                </div>
                <div class="flex items-center">
                    <input
                        type="checkbox"
                        id="doubleOut"
                        class="form-checkbox h-5 w-5 text-blue-600 rounded"
                    />
                    <label for="doubleOut" class="ml-2 text-lg text-gray-200">Double Out</label>
                </div>
                <div class="flex items-center mt-4">
                    <input
                        type="checkbox"
                        id="enableVoice"
                        class="form-checkbox h-5 w-5 text-blue-600 rounded"
                        checked
                    />
                    <label for="enableVoice" class="ml-2 text-lg text-gray-200">Activer la voix de l'IA</label>
                </div>
            </div>

            <!-- Bouton DÃ©marrer le jeu -->
            <button
                id="startGameBtn"
                class="btn-gradient btn-success w-full text-white font-bold py-3 px-6 rounded-md"
            >
                DÃ©marrer le Jeu
            </button>
        </div>

        <!-- Section du jeu en cours -->
        <div id="game-section" class="mb-8 p-4 bg-gray-700 rounded-lg shadow-inner border border-gray-600 hidden">
            <h2 id="game-mode-display" class="text-2xl font-bold mb-4 text-center text-yellow-300">
                Jeu en Cours: 501
            </h2>

            <!-- Affichage des scores des joueurs -->
            <div id="player-scores-display" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <!-- Les scores des joueurs seront ajoutÃ©s ici par JS -->
            </div>

            <!-- EntrÃ©e du score par flÃ©chette -->
            <div class="mb-4 text-center">
                <p class="text-xl font-semibold mb-2 text-orange-300">
                    C'est au tour de: <span id="current-player-name" class="text-yellow-400 font-extrabold text-2xl"></span>
                </p>

                <!-- Affichage des flÃ©chettes lancÃ©es au tour actuel -->
                <div class="bg-gray-900 p-3 rounded-md mb-4 border border-gray-600 shadow-md">
                    <p class="text-lg font-medium text-gray-300">
                        FlÃ©chettes du tour (<span id="darts-count" class="font-bold text-white">0</span>/3):
                        <span id="current-darts-display" class="font-bold text-white ml-2">Aucune</span>
                    </p>
                    <p class="text-lg font-medium text-gray-300 mt-1">
                        Multiplicateur sÃ©lectionnÃ©: <span id="selected-multiplier-display" class="font-bold text-yellow-300">Simple</span>
                    </p>
                </div>

                <!-- Boutons Multiplicateurs -->
                <div class="flex justify-center gap-2 mb-4">
                    <button
                        id="multiplier-simple"
                        class="p-3 rounded-md text-xl font-bold w-24 btn-gradient btn-info"
                    >
                        Simple (S)
                    </button>
                    <button
                        id="multiplier-double"
                        class="p-3 rounded-md text-xl font-bold w-24 btn-gradient btn-dark-gradient"
                    >
                        Double (D)
                    </button>
                    <button
                        id="multiplier-triple"
                        class="p-3 rounded-md text-xl font-bold w-24 btn-gradient btn-dark-gradient"
                    >
                        Triple (T)
                    </button>
                </div>

                <!-- Clavier numÃ©rique -->
                <div id="number-keypad" class="grid grid-cols-5 sm:grid-cols-7 gap-2 mb-4">
                    <!-- Les boutons numÃ©riques seront ajoutÃ©s ici par JS -->
                </div>

                <!-- Bouton Annuler la derniÃ¨re flÃ©chette -->
                <div class="flex justify-center mt-4">
                    <button
                        id="undoLastDartBtn"
                        class="btn-gradient btn-danger font-bold py-3 px-8 rounded-md opacity-50 cursor-not-allowed"
                        disabled
                    >
                        Annuler la derniÃ¨re flÃ©chette
                    </button>
                </div>
            </div>
        </div>

        <!-- Affichage du gagnant -->
        <div id="winner-section" class="text-center p-6 bg-green-700 rounded-lg shadow-xl border border-green-500 hidden">
            <h2 class="text-3xl font-bold text-white mb-4">ðŸŽ‰ FÃ©licitations ðŸŽ‰</h2>
            <p id="winner-name" class="text-4xl font-extrabold text-yellow-300 mb-6"></p>
            <button
                id="newGameWinnerBtn"
                class="btn-gradient btn-primary text-white font-bold py-3 px-8 rounded-md"
            >
                Nouveau Jeu
            </button>
        </div>

        <!-- Messages d'erreur/information -->
        <div id="message-section" class="mt-6 p-4 bg-red-600 rounded-md text-white text-center font-medium shadow-md hidden">
            <span id="message-text"></span>
        </div>

        <!-- Historique des scores -->
        <div id="history-section" class="mt-8 p-4 bg-gray-700 rounded-lg shadow-inner border border-gray-600 hidden">
            <h2 class="text-2xl font-bold mb-4 text-center text-cyan-300">Historique des Scores</h2>
            <div id="history-content" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- L'historique sera ajoutÃ© ici par JS -->
            </div>
        </div>

        <!-- Bouton RÃ©initialiser le jeu (toujours visible aprÃ¨s le dÃ©but ou la fin du jeu) -->
        <div id="reset-game-btn-container" class="mt-6 text-center hidden">
            <button
                id="resetGameBtn"
                class="btn-gradient btn-danger font-bold py-3 px-8 rounded-md"
            >
                RÃ©initialiser le Jeu
            </button>
        </div>
    </div>

    <script>
        // Global State
        let players = [];
        let newPlayerName = '';
        let gameMode = 501;
        let playerScores = {};
        let currentPlayerIndex = 0;
        let gameStarted = false;
        let winner = null;
        let message = '';
        let history = {};

        let doubleInActive = false;
        let doubleOutActive = false;
        let playerHasDoubledIn = {};

        let currentDartsThrown = [];
        let selectedMultiplier = 1; // 1: Simple, 2: Double, 3: Triple

        // AI Voice State
        let isVoiceActive = true; // Default to active
        let speechSynth = window.speechSynthesis;
        let voices = [];

        // Pre-defined AI comments/citations for general turn announcements
        const aiComments = [
            "Bonne chance pour ce tour !",
            "Que les flÃ©chettes soient avec vous.",
            "Visez juste !",
            "La prÃ©cision est la clÃ©.",
            "Un bon lancer commence par une bonne intention.",
            "Le tableau vous attend.",
            "Concentration maximale !",
            "Chaque point compte.",
            "Le chemin vers la victoire est pavÃ© de doubles.",
            "Un triple, et c'est la gloire !",
            "Attention au buste !",
            "Le sang-froid est votre meilleur alliÃ©."
        ];

        // Funny comments based on turn score
        const funnyComments = {
            'very_low': [
                "Oups, on dirait que la flÃ©chette a pris un chemin inattendu. Peut-Ãªtre qu'elle cherchait un cafÃ© ?",
                "Un score qui ferait pleurer une mouche. Courage, Ã§a ne peut que s'amÃ©liorer !",
                "Est-ce que c'Ã©tait une flÃ©chette ou un papillon qui volait ?",
                "On a vu plus de points dans un fromage suisse. RÃ©essayez !",
                "FÃ©licitations, vous avez Ã©vitÃ© le tableau avec brio. C'Ã©tait l'objectif, non ?",
                "Votre flÃ©chette a dÃ©cidÃ© de prendre des vacances. Elle reviendra, peut-Ãªtre avec plus de points.",
                "C'est ce qu'on appelle un score... minimaliste. TrÃ¨s minimaliste.",
                "On dirait que votre flÃ©chette a peur du noir. Visez la lumiÃ¨re la prochaine fois !",
                "Le score est si bas qu'il a froid. Donnez-lui une veste !",
                "Je crois que votre flÃ©chette a glissÃ© sur une peau de banane. Ã‡a arrive aux meilleurs... ou pas."
            ],
            'low': [
                "Pas de quoi casser trois pattes Ã  un canard, mais c'est un dÃ©but !",
                "On progresse, lentement mais sÃ»rement... trÃ¨s sÃ»rement.",
                "C'est un score modeste, mais l'important c'est de participer, n'est-ce pas ?",
                "Votre flÃ©chette a atterri, c'est dÃ©jÃ  Ã§a ! Les points viendront plus tard.",
                "Un petit pas pour l'homme, un petit score pour le joueur. La suite ?",
                "On dirait que votre flÃ©chette a fait une sieste en chemin. RÃ©veillez-la !",
                "C'est comme un rÃ©gime : on commence doucement. TrÃ¨s doucement.",
                "Votre score est comme un secret bien gardÃ© : personne ne le verra venir.",
                "La flÃ©chette a touchÃ© le tableau. C'est un bon dÃ©but pour un aveugle.",
                "Vous avez trouvÃ© le chemin... vers les petits chiffres. Bravo pour la cohÃ©rence !"
            ],
            'medium': [
                "Un score respectable, on sent le potentiel !",
                "Bien jouÃ©, Ã§a commence Ã  ressembler Ã  des flÃ©chettes !",
                "Ni bon, ni mauvais. Juste... efficace. Continuez comme Ã§a !",
                "La moyenne, c'est bien. Mais le top, c'est mieux !",
                "Vous Ãªtes sur la bonne voie, continuez Ã  viser le centre... ou pas.",
                "Un score solide, comme un bon vieux chÃªne. Pas spectaculaire, mais fiable.",
                "C'est un score qui dit : 'Je suis lÃ , mais je ne veux pas faire de vagues.'",
                "Votre flÃ©chette a trouvÃ© sa place. Elle n'est pas la star, mais elle est lÃ .",
                "Un score qui ne fera pas la une des journaux, mais qui fait le travail. Efficace !",
                "Vous Ãªtes le juste milieu. L'Ã©quilibre parfait entre le gÃ©nie et le dÃ©sastre."
            ],
            'good': [
                "Impressionnant ! Le tableau tremble encore !",
                "TrÃ¨s beau score, la flÃ©chette a trouvÃ© son chemin !",
                "Vous chauffez, vous chauffez... Le 180 n'est pas loin !",
                "Un score qui fait plaisir Ã  voir. C'est Ã§a, le talent !",
                "La flÃ©chette a dansÃ© sur le tableau. Magnifique prestation !",
                "Vous avez mis le paquet ! Ce score en dit long sur votre dÃ©termination.",
                "Un score qui donne le sourire. Continuez Ã  nous Ã©pater !",
                "La flÃ©chette a chantÃ© en atterrissant. Une mÃ©lodie de points !",
                "C'est un score qui mÃ©rite des applaudissements. Bravo l'artiste !",
                "Vous avez transformÃ© le tableau en chef-d'Å“uvre. Chaque flÃ©chette est un coup de pinceau."
            ],
            'high': [
                "Ouch ! Ã‡a, c'est un coup de maÃ®tre !",
                "Presque un 180 ! La tension monte !",
                "Le public est en dÃ©lire ! Quel score !",
                "Vous Ãªtes un sniper des flÃ©chettes ! Incroyable !",
                "La flÃ©chette a frÃ´lÃ© la perfection. Un exploit !",
                "Ce score est une dÃ©claration. Vous Ãªtes lÃ  pour gagner !",
                "Le tableau n'a pas vu Ã§a depuis longtemps. Un coup de gÃ©nie !",
                "Vous avez mis le feu au tableau ! Les points pleuvent !",
                "Un score qui restera dans les annales. LÃ©gendaire !",
                "Vous avez fait trembler les fondations. Le tableau n'est plus le mÃªme !"
            ],
            '180': [
                "180 ! Incroyable ! Un maximum absolu !",
                "C'est un 180 ! Le public est en folie ! Quel joueur !",
                "Trois triples 20 ! Le rÃªve de tout joueur de flÃ©chettes !",
                "Perfection ! Un 180 magistral !",
                "Le Saint Graal des flÃ©chettes ! Un 180 historique !",
                "La flÃ©chette a trouvÃ© sa maison, trois fois de suite ! 180 !",
                "C'est un chef-d'Å“uvre de prÃ©cision ! 180 points !",
                "Le tableau s'incline devant tant de talent ! 180 !",
                "Vous avez Ã©crit l'histoire avec ces trois flÃ©chettes ! 180 !",
                "Un moment de pure magie ! 180 points !"
            ],
            'bust': [
                "Bust ! La pression Ã©tait trop forte, n'est-ce pas ?",
                "Oh non, un buste ! Le tableau vous a jouÃ© un tour !",
                "Dommage, le buste est un piÃ¨ge redoutable. Mieux la prochaine fois !",
                "La flÃ©chette a dÃ©cidÃ© de faire une blague. C'Ã©tait un buste !",
                "Le buste, c'est comme un ami qui vous rappelle Ã  l'ordre. Doucement, mais sÃ»rement.",
                "Vous avez tentÃ© le coup, mais le buste a dit non. La prudence est de mise !",
                "C'est un buste. Le tableau a gagnÃ© cette manche. Mais la guerre n'est pas finie !",
                "La flÃ©chette a fait un dÃ©tour par la case 'dÃ©faite'. C'est un buste !",
                "Le buste est une leÃ§on. Apprenez-en et revenez plus fort !",
                "On dirait que votre flÃ©chette a eu le vertige. C'est un buste !"
            ]
        };

        function getRandomComment(category) {
            const comments = funnyComments[category];
            if (comments && comments.length > 0) {
                return comments[Math.floor(Math.random() * comments.length)];
            }
            return "";
        }

        // Ensure voices are loaded
        speechSynth.onvoiceschanged = () => {
            voices = speechSynth.getVoices();
            // Try to find a French voice, fallback to any available
            const frenchVoice = voices.find(voice => voice.lang === 'fr-FR');
            if (frenchVoice) {
                console.log("Voix franÃ§aise trouvÃ©e :", frenchVoice.name);
            } else {
                console.warn("Aucune voix franÃ§aise trouvÃ©e, utilisation de la voix par dÃ©faut.");
            }
        };

        // DOM Elements
        const configSection = document.getElementById('config-section');
        const gameSection = document.getElementById('game-section');
        const winnerSection = document.getElementById('winner-section');
        const messageSection = document.getElementById('message-section');
        const messageText = document.getElementById('message-text');
        const historySection = document.getElementById('history-section');
        const resetGameBtnContainer = document.getElementById('reset-game-btn-container');

        const newPlayerInput = document.getElementById('newPlayer');
        const addPlayerBtn = document.getElementById('addPlayerBtn');
        const playersListContainer = document.getElementById('players-list-container');
        const playersList = document.getElementById('players-list');
        const gameModeSelect = document.getElementById('gameMode');
        const doubleInCheckbox = document.getElementById('doubleIn');
        const doubleOutCheckbox = document.getElementById('doubleOut');
        const enableVoiceCheckbox = document.getElementById('enableVoice'); // New checkbox
        const startGameBtn = document.getElementById('startGameBtn');
        const resetGameBtn = document.getElementById('resetGameBtn');
        const newGameWinnerBtn = document.getElementById('newGameWinnerBtn');

        const gameModeDisplay = document.getElementById('game-mode-display');
        const playerScoresDisplay = document.getElementById('player-scores-display');
        const currentPlayerNameDisplay = document.getElementById('current-player-name');
        const dartsCountDisplay = document.getElementById('darts-count');
        const currentDartsDisplay = document.getElementById('current-darts-display');
        const selectedMultiplierDisplay = document.getElementById('selected-multiplier-display');
        const multiplierSimpleBtn = document.getElementById('multiplier-simple');
        const multiplierDoubleBtn = document.getElementById('multiplier-double');
        const multiplierTripleBtn = document.getElementById('multiplier-triple');
        const numberKeypad = document.getElementById('number-keypad');
        const undoLastDartBtn = document.getElementById('undoLastDartBtn');
        const winnerNameDisplay = document.getElementById('winner-name');
        const historyContent = document.getElementById('history-content');

        const numberButtons = [
            1, 2, 3, 4, 5, 6, 7, 8, 9, 10,
            11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
            25, 0 // Bullseye et Miss
        ];

        // Helper function to set messages and update UI
        function showMessage(msg) {
            message = msg;
            updateUI();
        }

        // Function to make the AI speak
        function speakMessage(text) {
            if (isVoiceActive && speechSynth) {
                speechSynth.cancel(); // Stop any current speech
                const utterance = new SpeechSynthesisUtterance(text);
                const frenchVoice = voices.find(voice => voice.lang === 'fr-FR');
                if (frenchVoice) {
                    utterance.voice = frenchVoice;
                }
                utterance.lang = 'fr-FR'; // Ensure language is set
                utterance.pitch = 1; // Default pitch
                utterance.rate = 1;  // Default rate
                speechSynth.speak(utterance);
            }
        }

        // Functions to update UI
        function updateUI() {
            // Toggle sections visibility
            configSection.classList.toggle('hidden', gameStarted || winner);
            gameSection.classList.toggle('hidden', !gameStarted || winner);
            winnerSection.classList.toggle('hidden', !winner);
            messageSection.classList.toggle('hidden', !message);
            historySection.classList.toggle('hidden', !(gameStarted || winner) || players.length === 0);
            resetGameBtnContainer.classList.toggle('hidden', !gameStarted && !winner);

            // Update message
            messageText.textContent = message;

            // Update players list in config
            renderPlayersList();

            // Update game mode display
            gameModeDisplay.textContent = `Jeu en Cours: ${gameMode}`;

            // Update player scores display
            renderPlayerScores();

            // Update current player info
            if (gameStarted && players.length > 0) {
                currentPlayerNameDisplay.textContent = players[currentPlayerIndex];
                dartsCountDisplay.textContent = currentDartsThrown.length;
                currentDartsDisplay.textContent = currentDartsThrown.length > 0 ?
                    currentDartsThrown.map(d => d.display).join(', ') : 'Aucune';
                selectedMultiplierDisplay.textContent = selectedMultiplier === 2 ? 'Double' : selectedMultiplier === 3 ? 'Triple' : 'Simple';

                // Update multiplier button styles
                multiplierSimpleBtn.classList.toggle('btn-info', selectedMultiplier === 1);
                multiplierSimpleBtn.classList.toggle('btn-dark-gradient', selectedMultiplier !== 1);
                multiplierSimpleBtn.classList.toggle('btn-multiplier-selected', selectedMultiplier === 1);

                multiplierDoubleBtn.classList.toggle('btn-info', selectedMultiplier === 2);
                multiplierDoubleBtn.classList.toggle('btn-dark-gradient', selectedMultiplier !== 2);
                multiplierDoubleBtn.classList.toggle('btn-multiplier-selected', selectedMultiplier === 2);

                multiplierTripleBtn.classList.toggle('btn-info', selectedMultiplier === 3);
                multiplierTripleBtn.classList.toggle('btn-dark-gradient', selectedMultiplier !== 3);
                multiplierTripleBtn.classList.toggle('btn-multiplier-selected', selectedMultiplier === 3);


                // Disable multiplier buttons if 3 darts thrown
                const disableMultiplierButtons = currentDartsThrown.length >= 3;
                multiplierSimpleBtn.disabled = disableMultiplierButtons;
                multiplierDoubleBtn.disabled = disableMultiplierButtons;
                multiplierTripleBtn.disabled = disableMultiplierButtons;
                multiplierSimpleBtn.classList.toggle('opacity-50', disableMultiplierButtons);
                multiplierSimpleBtn.classList.toggle('cursor-not-allowed', disableMultiplierButtons);
                multiplierDoubleBtn.classList.toggle('opacity-50', disableMultiplierButtons);
                multiplierDoubleBtn.classList.toggle('cursor-not-allowed', disableMultiplierButtons);
                multiplierTripleBtn.classList.toggle('opacity-50', disableMultiplierButtons);
                multiplierTripleBtn.classList.toggle('cursor-not-allowed', disableMultiplierButtons);

                // Disable number buttons if 3 darts thrown
                const disableNumberButtons = currentDartsThrown.length >= 3;
                numberKeypad.querySelectorAll('button').forEach(button => {
                    button.disabled = disableNumberButtons;
                    button.classList.toggle('opacity-50', disableNumberButtons);
                    button.classList.toggle('cursor-not-allowed', disableNumberButtons);
                });

                // Update undo button state
                undoLastDartBtn.disabled = currentDartsThrown.length === 0;
                undoLastDartBtn.classList.toggle('opacity-50', currentDartsThrown.length === 0);
                undoLastDartBtn.classList.toggle('cursor-not-allowed', currentDartsThrown.length === 0);
            }

            // Update winner display
            if (winner) {
                winnerNameDisplay.textContent = `${winner} a gagnÃ© le jeu !`;
            }

            // Update history display
            renderHistory();
        }

        function renderPlayersList() {
            playersList.innerHTML = ''; // Clear existing list
            if (players.length > 0) {
                playersListContainer.classList.remove('hidden');
                players.forEach((player, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-900 p-3 rounded-lg border border-gray-600 shadow-md';
                    li.innerHTML = `
                        <span class="text-lg text-gray-100">${player}</span>
                        <button
                            data-player="${player}"
                            class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-full text-sm transition duration-300 ease-in-out transform hover:scale-110"
                            title="Supprimer le joueur"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    `;
                    playersList.appendChild(li);
                });
            } else {
                playersListContainer.classList.add('hidden');
            }
        }

        function renderPlayerScores() {
            playerScoresDisplay.innerHTML = ''; // Clear existing scores
            players.forEach((player, index) => {
                const div = document.createElement('div');
                div.className = `p-4 rounded-lg shadow-xl text-center transition duration-300 ease-in-out transform ${
                    index === currentPlayerIndex ? 'bg-blue-600 border-blue-400 scale-105 player-card-active' : 'bg-gray-900 border-gray-600'
                }`;
                div.innerHTML = `
                    <h3 class="text-xl font-semibold mb-2 text-white">${player}</h3>
                    <p class="text-4xl font-extrabold text-green-400">${playerScores[player]}</p>
                    ${doubleInActive && !playerHasDoubledIn[player] ? '<p class="text-sm text-yellow-200 mt-1">Doit faire un Double In !</p>' : ''}
                `;
                playerScoresDisplay.appendChild(div);
            });
        }

        function renderNumberKeypad() {
            numberKeypad.innerHTML = ''; // Clear existing buttons
            numberButtons.forEach(num => {
                const button = document.createElement('button');
                button.textContent = num;
                button.className = `p-3 rounded-lg text-xl font-bold btn-gradient btn-dark-gradient`;
                button.dataset.value = num; // Store the number value
                numberKeypad.appendChild(button);
            });
        }

        function renderHistory() {
            historyContent.innerHTML = ''; // Clear existing history
            players.forEach(player => {
                const playerHistoryDiv = document.createElement('div');
                playerHistoryDiv.className = 'bg-gray-900 p-4 rounded-lg border border-gray-600 shadow-md';
                // Ensure history[player] is an array before calling .map()
                const playerHistoryEntries = history[player] || []; // Provide an empty array if undefined
                playerHistoryDiv.innerHTML = `
                    <h3 class="text-xl font-semibold mb-2 text-yellow-200">${player}</h3>
                    <ul class="max-h-48 overflow-y-auto custom-scrollbar">
                        ${playerHistoryEntries.map((entry, index) => `
                            <li class="mb-1 text-gray-300 text-left">
                                <span class="font-bold text-white">Tour ${index + 1}:</span> FlÃ©chettes: <span class="text-blue-300">${entry.darts}</span>, Score total: <span class="text-green-300">${entry.scoreEntered}</span>, Nouveau total: <span class="text-purple-300">${entry.newTotal}</span>
                                ${entry.message && `<span class="text-sm text-red-400 italic"> (${entry.message.replace(player + ' a fait un "bust" ! Son score reste Ã  ' + playerScores[player] + '.', 'Bust!')})</span>`}
                            </li>
                        `).join('')}
                    </ul>
                `;
                historyContent.appendChild(playerHistoryDiv);
            });
        }

        // Game Logic Functions
        function addPlayer() {
            const name = newPlayerInput.value.trim();
            if (name !== '' && !players.includes(name)) {
                players.push(name);
                // Initialize score and history for the new player immediately
                playerScores[name] = gameMode; // Initialize with default gameMode
                history[name] = []; // Initialize with an empty array
                playerHasDoubledIn[name] = false; // Initialize double-in status
                newPlayerInput.value = '';
                showMessage(''); // Use showMessage
                updateUI();
            } else if (name === '') {
                showMessage('Veuillez entrer un nom de joueur.'); // Use showMessage
            } else {
                showMessage('Ce joueur existe dÃ©jÃ .'); // Use showMessage
            }
        }

        function removePlayer(playerToRemove) {
            players = players.filter(player => player !== playerToRemove);
            delete playerScores[playerToRemove];
            delete history[playerToRemove];
            delete playerHasDoubledIn[playerToRemove];

            // Adjust current player index if needed
            if (currentPlayerIndex >= players.length && players.length > 0) {
                currentPlayerIndex = 0;
            } else if (players.length === 0) {
                // If no players left, reset game completely
                resetGame();
                return;
            }
            showMessage(''); // Use showMessage
            updateUI();
        }

        function startGame() {
            if (players.length === 0) {
                showMessage('Veuillez ajouter au moins un joueur avant de commencer.'); // Use showMessage
                return;
            }
            gameStarted = true;
            winner = null;
            message = ''; // Clear message
            gameMode = parseInt(gameModeSelect.value, 10);
            doubleInActive = doubleInCheckbox.checked;
            doubleOutActive = doubleOutCheckbox.checked;
            isVoiceActive = enableVoiceCheckbox.checked; // Get voice setting

            // Initialize scores and double-in status for new game
            playerScores = {};
            history = {};
            playerHasDoubledIn = {};
            players.forEach(player => {
                playerScores[player] = gameMode;
                history[player] = [];
                playerHasDoubledIn[player] = false;
            });
            currentPlayerIndex = 0;
            currentDartsThrown = [];
            selectedMultiplier = 1;

            updateUI();
            // Initial announcement for the first player
            let initialMessage = `Le jeu commence en mode ${gameMode}. C'est au tour de ${players[currentPlayerIndex]}.`;
            if (playerScores[players[currentPlayerIndex]] <= 170) {
                initialMessage += ` Il vous reste ${playerScores[players[currentPlayerIndex]]} points.`;
            }
            initialMessage += ` ${aiComments[Math.floor(Math.random() * aiComments.length)]}`;
            speakMessage(initialMessage);
        }

        function resetGame() {
            players = [];
            newPlayerName = '';
            gameMode = 501;
            playerScores = {};
            currentPlayerIndex = 0;
            gameStarted = false;
            winner = null;
            message = ''; // Clear message
            history = {};
            doubleInActive = false;
            doubleOutActive = false;
            playerHasDoubledIn = {};
            currentDartsThrown = [];
            selectedMultiplier = 1;

            // Reset checkboxes and select
            gameModeSelect.value = 501;
            doubleInCheckbox.checked = false;
            doubleOutCheckbox.checked = false;
            enableVoiceCheckbox.checked = true; // Reset voice to active by default

            updateUI();
            speakMessage("Jeu rÃ©initialisÃ©. Bienvenue aux flÃ©chettes !");
        }

        function submitTurn(dartsForThisTurn) {
            const currentPlayer = players[currentPlayerIndex];
            let currentTotalScore = playerScores[currentPlayer];
            let totalTurnScore = dartsForThisTurn.reduce((sum, dart) => sum + dart.score, 0);

            let newScore = currentTotalScore - totalTurnScore;
            let turnMessage = '';
            let gameEnded = false;
            let aiVoiceMessages = [];

            // Handle "Double In" rule
            if (doubleInActive && !playerHasDoubledIn[currentPlayer]) {
                const hasHitDouble = dartsForThisTurn.some(dart => dart.multiplier === 2 && dart.value !== 0);
                if (hasHitDouble) {
                    playerHasDoubledIn[currentPlayer] = true;
                    turnMessage = `${currentPlayer} a rÃ©ussi son "Double In" !`;
                    aiVoiceMessages.push(turnMessage);
                    // Points are counted normally
                } else {
                    turnMessage = `${currentPlayer} n'a pas fait de "Double In". Le score de ${totalTurnScore} ne compte pas.`;
                    newScore = currentTotalScore; // Score does not change
                    aiVoiceMessages.push(turnMessage);
                }
            }

            // Handle "bust" (score less than 0 or equal to 1)
            if (newScore < 0 || newScore === 1) {
                turnMessage = `${currentPlayer} a fait un "bust" ! Son score reste Ã  ${currentTotalScore}.`;
                newScore = currentTotalScore; // Score does not change on bust
                aiVoiceMessages.push(turnMessage);
            } else if (newScore === 0) {
                // Handle "Double Out" rule if active
                if (doubleOutActive) {
                    const lastDart = dartsForThisTurn[dartsForThisTurn.length - 1];
                    if (lastDart && lastDart.multiplier === 2 && lastDart.value !== 0) { // Check if the last dart was a double (not a 0)
                        turnMessage = `${currentPlayer} a gagnÃ© avec un "Double Out" !`;
                        winner = currentPlayer;
                        gameStarted = false;
                        gameEnded = true;
                        aiVoiceMessages.push(`${currentPlayer} a gagnÃ© avec un Double Out ! FÃ©licitations !`);
                    } else {
                        turnMessage = `${currentPlayer} a fait un "bust" ! Doit terminer avec un "Double Out". Son score reste Ã  ${currentTotalScore}.`;
                        newScore = currentTotalScore; // Bust if no double out
                        aiVoiceMessages.push(turnMessage);
                    }
                } else {
                    turnMessage = `${currentPlayer} a gagnÃ© avec un "Straight Out" !`;
                    winner = currentPlayer;
                    gameStarted = false;
                    gameEnded = true;
                    aiVoiceMessages.push(`${currentPlayer} a gagnÃ© avec un Straight Out ! Bravo !`);
                }
            }

            // Add turn summary and funny comment
            if (!gameEnded) { // Only add if game is not finished by this turn
                let commentCategory;
                if (totalTurnScore === 0) commentCategory = 'very_low'; // For 0 points
                else if (totalTurnScore <= 20) commentCategory = 'very_low';
                else if (totalTurnScore <= 40) commentCategory = 'low';
                else if (totalTurnScore <= 80) commentCategory = 'medium';
                else if (totalTurnScore <= 120) commentCategory = 'good';
                else if (totalTurnScore <= 179) commentCategory = 'high';
                else if (totalTurnScore === 180) commentCategory = '180';
                else commentCategory = 'medium'; // Fallback

                if (newScore === currentTotalScore && totalTurnScore > 0) { // If it was a bust but they scored points
                    commentCategory = 'bust';
                }

                const turnSummary = `${currentPlayer} a fait ${totalTurnScore} points. ${getRandomComment(commentCategory)}`;
                aiVoiceMessages.push(turnSummary);
            }


            // Update scores and history
            playerScores[currentPlayer] = newScore;
            history[currentPlayer].push({
                darts: dartsForThisTurn.map(d => d.display).join(', '),
                scoreEntered: totalTurnScore,
                newTotal: newScore,
                message: turnMessage
            });

            // Reset states for the next turn
            currentDartsThrown = [];
            selectedMultiplier = 1;
            showMessage(turnMessage); // Update visual message

            // Speak all accumulated messages sequentially
            let delay = 0;
            aiVoiceMessages.forEach(msg => {
                setTimeout(() => speakMessage(msg), delay);
                delay += msg.length * 50; // Estimate time based on message length for sequential speaking
            });


            // Move to next player if game is not ended
            if (!gameEnded) {
                // Determine next player
                const nextPlayerIndex = (currentPlayerIndex + 1) % players.length;
                const nextPlayerName = players[nextPlayerIndex];
                const nextPlayerScore = playerScores[nextPlayerName];

                setTimeout(() => { // Delay for previous messages to finish
                    currentPlayerIndex = nextPlayerIndex; // Update current player index
                    let nextTurnAnnouncement = `C'est au tour de ${nextPlayerName}.`;
                    if (nextPlayerScore <= 170 && nextPlayerScore > 1) { // Announce remaining score if <= 170 and not 0 or 1
                        nextTurnAnnouncement += ` Il vous reste ${nextPlayerScore} points.`;
                    }
                    nextTurnAnnouncement += ` ${aiComments[Math.floor(Math.random() * aiComments.length)]}`;
                    speakMessage(nextTurnAnnouncement);
                    updateUI(); // Update UI after player change and message
                }, delay + 500); // Add a small buffer after all messages
            } else {
                updateUI(); // Update UI immediately if game ended
            }
        }

        function handleMultiplierClick(multiplier) {
            if (currentDartsThrown.length >= 3) {
                showMessage('Vous avez dÃ©jÃ  lancÃ© 3 flÃ©chettes pour ce tour.'); // Use showMessage
                updateUI();
                return;
            }
            selectedMultiplier = multiplier;
            showMessage(''); // Clear previous messages
            updateUI();
        }

        function handleNumberClick(num) {
            if (currentDartsThrown.length >= 3) {
                showMessage('Vous avez dÃ©jÃ  lancÃ© 3 flÃ©chettes pour ce tour.'); // Use showMessage
                updateUI();
                return;
            }

            // Specific validation for bullseye and triples
            if (num === 25 && selectedMultiplier === 3) {
                showMessage('Le Bullseye (25) ne peut pas Ãªtre un Triple. Veuillez choisir Double ou Simple.'); // Use showMessage
                updateUI();
                return;
            }
            if (num === 0 && selectedMultiplier !== 1) {
                showMessage('Un "miss" (0) ne peut pas Ãªtre un Double ou Triple.'); // Use showMessage
                updateUI();
                return;
            }

            const displayMultiplier = selectedMultiplier === 2 ? 'D' : selectedMultiplier === 3 ? 'T' : '';
            const dartScore = num * selectedMultiplier;

            const newDartsThrown = [...currentDartsThrown, {
                value: num,
                multiplier: selectedMultiplier,
                score: dartScore,
                display: `${displayMultiplier}${num}`
            }];

            currentDartsThrown = newDartsThrown;

            // Reset for the next dart
            selectedMultiplier = 1; // Reset multiplier after dart added
            showMessage(''); // Clear message

            // If 3 darts have been thrown, automatically submit the turn
            if (currentDartsThrown.length === 3) {
                submitTurn(currentDartsThrown);
            } else {
                updateUI(); // Update UI immediately after adding dart if turn not finished
            }
        }

        function undoLastDart() {
            if (currentDartsThrown.length > 0) {
                currentDartsThrown.pop(); // Remove last dart
                selectedMultiplier = 1; // Reset multiplier
                showMessage(''); // Clear message
                updateUI();
            } else {
                showMessage('Aucune flÃ©chette Ã  annuler pour ce tour.'); // Use showMessage
                updateUI();
            }
        }

        // Event Listeners
        addPlayerBtn.addEventListener('click', addPlayer);
        newPlayerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addPlayer();
        });

        playersList.addEventListener('click', (e) => {
            if (e.target.closest('button')) {
                const playerToRemove = e.target.closest('button').dataset.player;
                if (playerToRemove) {
                    removePlayer(playerToRemove);
                }
            }
        });

        startGameBtn.addEventListener('click', startGame);
        resetGameBtn.addEventListener('click', resetGame);
        newGameWinnerBtn.addEventListener('click', resetGame);

        enableVoiceCheckbox.addEventListener('change', (e) => {
            isVoiceActive = e.target.checked;
            if (!isVoiceActive) {
                speechSynth.cancel(); // Stop speech if voice is disabled
            }
        });

        multiplierSimpleBtn.addEventListener('click', () => handleMultiplierClick(1));
        multiplierDoubleBtn.addEventListener('click', () => handleMultiplierClick(2));
        multiplierTripleBtn.addEventListener('click', () => handleMultiplierClick(3));

        numberKeypad.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const num = parseInt(e.target.dataset.value, 10);
                handleNumberClick(num);
            }
        });

        undoLastDartBtn.addEventListener('click', undoLastDart);

        // Initial render on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderNumberKeypad(); // Render number buttons once
            updateUI(); // Initial UI update
        });

    </script>
</body>
</html>
